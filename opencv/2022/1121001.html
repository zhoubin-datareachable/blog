<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>模板匹配 | 博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.efd317d0.css" as="style"><link rel="preload" href="/assets/js/app.012a0edf.js" as="script"><link rel="preload" href="/assets/js/5.a1716bf7.js" as="script"><link rel="preload" href="/assets/js/1.c02cc300.js" as="script"><link rel="preload" href="/assets/js/21.415aabec.js" as="script"><link rel="prefetch" href="/assets/js/10.7c4bb012.js"><link rel="prefetch" href="/assets/js/11.b67b2bcd.js"><link rel="prefetch" href="/assets/js/12.c8f0af63.js"><link rel="prefetch" href="/assets/js/13.57e2b9c6.js"><link rel="prefetch" href="/assets/js/14.40a93606.js"><link rel="prefetch" href="/assets/js/15.9007bf94.js"><link rel="prefetch" href="/assets/js/16.04a770c9.js"><link rel="prefetch" href="/assets/js/17.0d446c7c.js"><link rel="prefetch" href="/assets/js/18.64393348.js"><link rel="prefetch" href="/assets/js/19.a1d55143.js"><link rel="prefetch" href="/assets/js/20.bd453d07.js"><link rel="prefetch" href="/assets/js/22.71efdc9b.js"><link rel="prefetch" href="/assets/js/23.33ddba6b.js"><link rel="prefetch" href="/assets/js/24.2ff2d230.js"><link rel="prefetch" href="/assets/js/25.dc0996e9.js"><link rel="prefetch" href="/assets/js/26.c444f4b0.js"><link rel="prefetch" href="/assets/js/27.1843522b.js"><link rel="prefetch" href="/assets/js/28.ff5b4a87.js"><link rel="prefetch" href="/assets/js/29.b2fcf514.js"><link rel="prefetch" href="/assets/js/3.08e70b32.js"><link rel="prefetch" href="/assets/js/30.15235e19.js"><link rel="prefetch" href="/assets/js/31.aa077a4f.js"><link rel="prefetch" href="/assets/js/32.913449fd.js"><link rel="prefetch" href="/assets/js/33.cf145cd0.js"><link rel="prefetch" href="/assets/js/34.2581e662.js"><link rel="prefetch" href="/assets/js/35.4d93b7a6.js"><link rel="prefetch" href="/assets/js/36.f9408bc3.js"><link rel="prefetch" href="/assets/js/37.d77f557e.js"><link rel="prefetch" href="/assets/js/38.5dd13250.js"><link rel="prefetch" href="/assets/js/39.1d6c1a7b.js"><link rel="prefetch" href="/assets/js/4.b78c416b.js"><link rel="prefetch" href="/assets/js/40.39f16d3f.js"><link rel="prefetch" href="/assets/js/41.043cd6e3.js"><link rel="prefetch" href="/assets/js/42.60753a9a.js"><link rel="prefetch" href="/assets/js/43.995e795b.js"><link rel="prefetch" href="/assets/js/44.175368ac.js"><link rel="prefetch" href="/assets/js/45.0bacf9c4.js"><link rel="prefetch" href="/assets/js/46.6012e160.js"><link rel="prefetch" href="/assets/js/47.edc2da20.js"><link rel="prefetch" href="/assets/js/6.9a940ebd.js"><link rel="prefetch" href="/assets/js/7.405563d4.js"><link rel="prefetch" href="/assets/js/8.91d57c95.js"><link rel="prefetch" href="/assets/js/9.6d9a13e7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.efd317d0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-5bb33761><div data-v-5bb33761><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-5bb33761 data-v-5bb33761><h3 class="title" data-v-59e6cb88>博客</h3> <p class="description" data-v-59e6cb88></p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>土豆</span>
          
        <span data-v-59e6cb88>2021 - </span>
        2022
      </a></span></div></div> <div class="hide" data-v-5bb33761><header class="navbar" data-v-5bb33761><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  home
</a></div><div class="nav-item"><a href="/other/2022/0929001.html" class="nav-link"><i class="iconfont reco-other"></i>
  软件
</a></div><div class="nav-item"><a href="https://github.com/zhoubin-datareachable" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://support.qq.com/product/435903" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-suggestion"></i>
  留言板
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-5bb33761></div> <aside class="sidebar" data-v-5bb33761><div class="personal-info-wrapper" data-v-1fad0c41 data-v-5bb33761><img src="/avatar.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    土豆
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>36</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>15</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  home
</a></div><div class="nav-item"><a href="/other/2022/0929001.html" class="nav-link"><i class="iconfont reco-other"></i>
  软件
</a></div><div class="nav-item"><a href="https://github.com/zhoubin-datareachable" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://support.qq.com/product/435903" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-suggestion"></i>
  留言板
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-5bb33761><h3 class="title" data-v-59e6cb88>模板匹配</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>土豆</span>
          
        <span data-v-59e6cb88>2021 - </span>
        2022
      </a></span></div></div> <div data-v-5bb33761><div data-v-5bb33761><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">模板匹配</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>土豆</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2022/11/21</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>openCV</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="思维导图"><a href="#思维导图" class="header-anchor">#</a> 思维导图</h2> <p><img src="/assets/img/image-20221122210630537.d9b3a420.png" alt="image-20221122210630537"></p> <p>模板匹配是指在当前<strong>图像A</strong>内寻找与图像B<strong>最相似</strong>的部分，一般将图像<strong>A称为输入图像</strong>，将图像<strong>B称为模板图像</strong>。模板匹配的操作方法是将模板<strong>图像B在图像A上滑动</strong>，遍历所有像素以完成匹配。</p> <p><img src="/assets/img/image-20221115205633-2gkofzj.6007f09c.png" alt="image.png"></p> <h2 id="模板匹配基础"><a href="#模板匹配基础" class="header-anchor">#</a> 模板匹配基础</h2> <p>在OpenCV内，模板匹配是使用函数cv2.matchTemplate()实现的。该函数的语法格式为：</p> <div class="language-python extra-class"><pre class="language-python"><code>result <span class="token operator">=</span> cv2<span class="token punctuation">.</span>matchTemplate<span class="token punctuation">(</span>image<span class="token punctuation">,</span> templ<span class="token punctuation">,</span> method<span class="token punctuation">[</span><span class="token punctuation">,</span> mask <span class="token punctuation">]</span> <span class="token punctuation">)</span>
</code></pre></div><ul><li>image为原始图像，必须是8位或者32位的浮点型图像。</li> <li>templ为模板图像。它的尺寸<strong>必须小于或等于原始图像</strong>，并且与原始图像具有<strong>同样的类型</strong>。</li> <li>mask为模板图像掩模。它必须和模板图像templ具有<strong>相同的类型和大小</strong>。通常情况下该值使用默认值即可。当前，该参数仅支持TM_SQDIFF和TM_CCORR_NORMED两个值。</li> <li>method为匹配方法。该参数通过TemplateMatchModes实现，有6种可能的值</li></ul> <p><img src="/assets/img/image-20221115205829-6l5q3ol.57aaa8f6.png" alt="image.png"></p> <p>其具体对应的计算公式如表15-2所示。</p> <p><img src="/assets/img/image-20221115205829-6l5q3ol-16691225415723.57aaa8f6.png" alt="image.png"></p> <p>函数cv2.matchTemplate()的返回值result是由<strong>每个位置的比较结果组合</strong>所构成的一个结果集，类型是单通道32位浮点型。如果输入图像（原始图像）尺寸是W×H*，模板的尺寸是<em>w×h，则返回值的大小为(W-w+1)</em>(H-h+1)。</p> <p>在进行模板匹配时，模板在原始图像内遍历。在水平方向上：</p> <p>● 遍历的起始坐标是原始图像左数第1个像素值（序号从1开始）。</p> <p>● 最后一次比较是当模板图像位于原始图像的最右侧时，此时其左上角像素点所在的位置是W-w+1。</p> <p>因此，返回值result在水平方向上的大小是W-w+1（水平方向上的比较次数）。</p> <p>如果原始图像尺寸是W×H*，模板的尺寸是*w×h，则返回值的大小为(W-w+1)×(H-h+1)也就是说，模板图像要在输入图像内比较(W-w+1)×(H-h+1)次。</p> <p>例如，在图中，左上方的2×2小方块是<strong>模板图像</strong>，右下方的10×10图像是<strong>输入图像</strong>（原始图像）。在进行模板匹配时：</p> <p><img src="/assets/img/image-20221122201838-5gqdyb9.65e26f9f.png" alt="image.png"></p> <ul><li>首先将模板图像置于输入图像的左上角。</li> <li>模板图像在向右移动时，最远只能位于输入图像的最右侧边界处，此时模板图像左上角的像素对应着输入图像的第9列（输入图像宽度-模板图像宽度+1=10-2+1=9）。</li> <li>模板图像在向下移动时，最远只能位于输入图像最下端的边界处。此时模板图像左上角的像素对应着输入图像的第9行（输入图像高度-模板图像高度+1=10-2+1=9）。</li></ul> <p>根据上述分析可知，比较结果result的大小满足(W-w+1)*(H-h+1)，在上例中就是(10-2+1) ×(10-2+1)，即9×9。也就是说，模板图像要在输入图像内总计比较9×9=81次，这些比较结果将构成一个9×9大小的二维数组</p> <p>这里需要注意的是，函数cv2.matchTemplate()通过参数method来决定使用不同的查找方法。对于不同的查找方法，返回值result具有不同的含义。例如：</p> <ul><li>method的值为cv2.TM_SQDIFF和cv2.TM_SQDIFF_NORMED时，result值为0表示匹配度最好，<strong>值越大，表示匹配度越差</strong>。</li> <li>method的值为cv2.TM_CCORR、cv2.TM_CCORR_NORMED、cv2.TM_CCOEFF和cv2.TM_CCOEFF_NORMED时，result的<strong>值越小表示匹配度越差</strong>，<strong>值越大表示匹配度越好</strong>。</li></ul> <p>从上述分析可以看出，查找方法不同，结果的判定方式也不同。在查找最佳匹配时，首先要确定使用的是何种method，然后再确定到底是查找最大值，还是查找最小值。查找最值（极值）与最值所在的位置，可以使用cv2.minMaxLoc()函数实现。该函数语法格式如下：</p> <div class="language-python extra-class"><pre class="language-python"><code>minVal<span class="token punctuation">,</span> maxVal<span class="token punctuation">,</span> minLoc<span class="token punctuation">,</span> maxLoc   <span class="token operator">=</span> cv2<span class="token punctuation">.</span>minMaxLoc<span class="token punctuation">(</span> src <span class="token punctuation">[</span><span class="token punctuation">,</span> mask<span class="token punctuation">]</span> <span class="token punctuation">)</span>
</code></pre></div><ul><li>src为单通道数组。</li> <li>minVal为返回的最小值，如果没有最小值，则可以是NULL（空值）。</li> <li>maxVal为返回的最大值，如果没有最小值，则可以是NULL。</li> <li>minLoc为最小值的位置，如果没有最大值，则可以是NULL。</li> <li>maxLoc为最大值的位置，如果没有最大值，则可以是NULL。</li> <li>mask为用来选取掩模的子集，可选项。</li></ul> <p>函数cv2.minMaxLoc()能够查找整个数组内的最值及它们的位置，并且可以根据当前的掩模集来选取特定子集的极值。</p> <p>函数cv2.matchTemplate()返回值中的最值位置就是模板匹配的位置。当然，选用表15-1中的不同参数值，匹配位置可能位于最大值所在的位置也可能位于最小值所在的位置。通过函数cv2.minMaxLoc()来查找函数cv2.matchTemplate()返回值中的最值位置，就可以找到最佳模板匹配的位置例如，当method的值为cv2.TM_SQDIFF和cv2.TM_SQDIFF_NORMED时，0表示最佳匹配，值越大，则表示匹配效果越差。因此，在使用这两种方法时，要寻找最小值所在的位置作为最佳匹配。如下语句能够找到cv2.matchTemplate()函数返回值中最小值的位置：</p> <div class="language-python extra-class"><pre class="language-python"><code>minVal<span class="token punctuation">,</span> maxVal<span class="token punctuation">,</span> minLoc<span class="token punctuation">,</span> maxLoc <span class="token operator">=</span> cv2<span class="token punctuation">.</span>minMaxLoc<span class="token punctuation">(</span>matchTemplate函数的返回值<span class="token punctuation">)</span>
topLeft <span class="token operator">=</span> minLoc                          <span class="token comment"># 查找最小值所在的位置</span>
</code></pre></div><p>以topLeft点为模板匹配位置的左上角坐标，结合模板图像的宽度w和高度h可以确定匹配位置的右下角坐标，代码如下所示：</p> <div class="language-python extra-class"><pre class="language-python"><code>bottomRight <span class="token operator">=</span> <span class="token punctuation">(</span>topLeft<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w<span class="token punctuation">,</span> topLeft<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> h<span class="token punctuation">)</span>    <span class="token comment">#w和h是模板图像的宽度和高度</span>
</code></pre></div><p>当method的值为cv2.TM_CCORR、cv2.TM_CCORR_NORMED、cv2.TM_CCOEFF和cv2.TM_CCOEFF_NORMED时，cv2.matchTemplate()函数的返回值越小，表示匹配度越差，而返回值越大则表示匹配度越好。此时，要寻找最大值所在的位置作为最佳匹配。如下语句能够找到模板匹配返回值中最大值的位置，并以该点为左上角，结合模板的宽度w和高度h确定匹配位置的右下角坐标。</p> <div class="language-python extra-class"><pre class="language-python"><code>minVal<span class="token punctuation">,</span> maxVal<span class="token punctuation">,</span> minLoc<span class="token punctuation">,</span> maxLoc <span class="token operator">=</span> cv2<span class="token punctuation">.</span>minMaxLoc<span class="token punctuation">(</span>matchTemplate函数的返回值<span class="token punctuation">)</span>
topLeft <span class="token operator">=</span> maxLoc         <span class="token comment"># 查找最大值所在的位置</span>
bottomRight <span class="token operator">=</span> <span class="token punctuation">(</span>topLeft<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w<span class="token punctuation">,</span> topLeft<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> h<span class="token punctuation">)</span>        <span class="token comment"># w和h是模板的宽度和高度</span>
</code></pre></div><p>通过上述方式，我们确定了模板匹配的矩形对角坐标位置，接下来可以借助函数cv2.rectangle()将该位置用白色标记出来。函数cv2.rectangle的语法格式为：</p> <div class="language-python extra-class"><pre class="language-python"><code>Img <span class="token operator">=</span> cv<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span> img<span class="token punctuation">,</span> pt1<span class="token punctuation">,</span> pt2<span class="token punctuation">,</span> color<span class="token punctuation">[</span><span class="token punctuation">,</span> thickness<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>img表示要标记的目标图像。</li> <li>pt1是矩形的顶点。</li> <li>pt2是pt1的对角顶点。</li> <li>color是要绘制矩形的颜色或灰度级（灰度图像）。</li> <li>thickness是矩形边线的宽度。</li></ul> <p>因此，使用的标记语句为：</p> <div class="language-python extra-class"><pre class="language-python"><code>cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> topLeft<span class="token punctuation">,</span> bottomRight<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><p>该语句表示，在img内标记一个矩形，矩形的两个对角顶点为topLeft和bottomRight，矩形颜色为白色（255），宽度为2。</p> <p><strong>例一</strong>：使用函数cv2.matchTemplate()进行模板匹配。要求参数method的值设置为cv2.TM_SQDIFF，显示函数的返回结果及匹配结果。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
<span class="token comment"># 原始图像</span>
img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'lena512g.bmp'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment"># 模板图像</span>
template <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'temp.bmp'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment"># 获取模板图像的宽高</span>
th<span class="token punctuation">,</span> tw <span class="token operator">=</span> template<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
<span class="token comment"># 进行匹配</span>
rv <span class="token operator">=</span> cv2<span class="token punctuation">.</span>matchTemplate<span class="token punctuation">(</span>img<span class="token punctuation">,</span> template<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>TM_SQDIFF<span class="token punctuation">)</span>
minVal<span class="token punctuation">,</span> maxVal<span class="token punctuation">,</span> minLoc<span class="token punctuation">,</span> maxLoc <span class="token operator">=</span> cv2<span class="token punctuation">.</span>minMaxLoc<span class="token punctuation">(</span>rv<span class="token punctuation">)</span>
<span class="token comment"># 获取最小值坐标</span>
topLeft <span class="token operator">=</span> minLoc
<span class="token comment"># 获取右下角点坐标</span>
bottomRight <span class="token operator">=</span> <span class="token punctuation">(</span>topLeft<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> tw<span class="token punctuation">,</span> topLeft<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> th<span class="token punctuation">)</span>
<span class="token comment"># 绘制矩形</span>
cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> topLeft<span class="token punctuation">,</span> bottomRight<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment"># 显示图像</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">121</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>rv<span class="token punctuation">,</span> cmap <span class="token operator">=</span> <span class="token string">'gray'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Matching Result'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>yticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">122</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cmap <span class="token operator">=</span> <span class="token string">'gray'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Detected Point'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>yticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/assets/img/image-20221122203538-87qjp7a.37866e00.png" alt="image.png"></p> <p>运行上述代码，得到如图15-4所示结果，其中左图是函数cv2.matchTemplate()的返回值，右图是模板匹配的结果。</p> <p><img src="/assets/img/image-20221122203601-he88gcs.0e04ca04.png" alt="image.png"></p> <p><strong>实例二</strong>：使用cv2.matchTemplate()函数进行模板匹配。要求参数method的值设置为cv2.TM_CCOEFF，显示函数的返回结果及匹配结果。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
<span class="token comment"># 原始图像</span>
img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'lena512g.bmp'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment"># 模板图像</span>
template <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'temp.bmp'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment"># 获取模板宽高</span>
tw<span class="token punctuation">,</span> th <span class="token operator">=</span> template<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment"># 匹配运算</span>
rv <span class="token operator">=</span> cv2<span class="token punctuation">.</span>matchTemplate<span class="token punctuation">(</span>img<span class="token punctuation">,</span> template<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>TM_CCOEFF<span class="token punctuation">)</span>
minVal<span class="token punctuation">,</span> maxVal<span class="token punctuation">,</span> minLoc<span class="token punctuation">,</span> maxLoc <span class="token operator">=</span> cv2<span class="token punctuation">.</span>minMaxLoc<span class="token punctuation">(</span>rv<span class="token punctuation">)</span>
<span class="token comment"># 最大值坐标</span>
topLeft <span class="token operator">=</span> maxLoc
<span class="token comment"># 右下角点坐标</span>
bottomRight <span class="token operator">=</span> <span class="token punctuation">(</span>topLeft<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> tw<span class="token punctuation">,</span> topLeft<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> th<span class="token punctuation">)</span>
<span class="token comment"># 绘制矩形</span>
cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> topLeft<span class="token punctuation">,</span> bottomRight<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment"># 显示图像</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">121</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>rv<span class="token punctuation">,</span> cmap <span class="token operator">=</span> <span class="token string">'gray'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Matching Result'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>yticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">122</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cmap <span class="token operator">=</span> <span class="token string">'gray'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Detected Point'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>yticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/assets/img/image-20221122203845-0w0iw6x.b41aac3b.png" alt="image.png"></p> <h2 id="多模板匹配"><a href="#多模板匹配" class="header-anchor">#</a> 多模板匹配</h2> <p>我们在输入图像lena中搜索其眼部子图，该子图在整个输入图像内<strong>仅出现了一次</strong>。但是，有些情况下，要搜索的模板图像很可能在输入图像内出现了多次，这时就需要<strong>找出多个匹配结果</strong>。而函数cv2.minMaxLoc()仅仅能够找出最值，无法给出所有匹配区域的位置信息。所以，要想匹配多个结果，使用函数cv2.minMaxLoc()是无法实现的，需要<strong>利用阈值进行处理</strong>。</p> <h3 id="_1-获取匹配位置的集合"><a href="#_1-获取匹配位置的集合" class="header-anchor">#</a> <strong>1.获取匹配位置的集合</strong></h3> <p>函数<strong>where()<strong>能够获取模板匹配</strong>位置的集合</strong>。对于不同的输入，其返回的值是不同的。</p> <ul><li>当输入（参数）是一维数组时，返回值是一维索引，只有一组索引数组。</li> <li>当输入是二维数组时，返回的是匹配值的位置索引，因此会有两组索引数组表示返回值的位置。</li></ul> <p>以下代码查找在一维数组a中，数值大于5的元素的索引（即该元素所在的位置，数组的索引从0开始）：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
a<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
b<span class="token operator">=</span>np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>a<span class="token operator">&gt;</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
</code></pre></div><p>该段代码返回的结果为：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">(</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>int64<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>
</code></pre></div><p>说明索引值为1、2、5的数组元素，它们的值是大于5的。</p> <p>上面介绍的是输入值为一维数组时的情况。当输入值是二维数组时，函数where()会返回满足条件的值在二维数组中的索引。例如，以下代码查找在二维数组am中，值大于5的元素的索引：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
am<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">77</span><span class="token punctuation">,</span><span class="token number">66</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">98</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">67</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
b<span class="token operator">=</span>np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>am<span class="token operator">&gt;</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
</code></pre></div><p>该段代码返回的结果为：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">(</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>int64<span class="token punctuation">)</span><span class="token punctuation">,</span>
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>int64<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>上述结果说明，存在二维数组am，它的值为：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">3</span>  <span class="token number">6</span>  <span class="token number">8</span> <span class="token number">77</span> <span class="token number">66</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span> <span class="token number">1</span>  <span class="token number">2</span> <span class="token number">88</span>  <span class="token number">3</span> <span class="token number">98</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">11</span>  <span class="token number">2</span> <span class="token number">67</span>  <span class="token number">5</span>  <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre></div><p>其中，位置[0, 1]、[0, 2]、[0, 3]、[0, 4]、[1, 2]、[1, 4]、[2, 0]、[2, 2]上的元素值大于5。</p> <p>综上所述，函数np.where()可以找出在函数cv2.matchTemplate()的返回值中，哪些位置上的值是<strong>大于阈值threshold的</strong>。在具体实现时，可以采用的语句为：</p> <div class="language-python extra-class"><pre class="language-python"><code>loc <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span> res <span class="token operator">&gt;=</span> threshold<span class="token punctuation">)</span>
</code></pre></div><ul><li>res是函数cv2.matchTemplate()进行模板匹配后的返回值。</li> <li>threshold是预设的阈值</li> <li>loc是满足“res &gt;= threshold”的像素点的索引集合。例如，在上面的二维数组am中，返回的大于5的元素索引集合为(array([0, 0, 0, 0, 1, 1, 2, 2],dtype=int64), array([1, 2, 3, 4, 2, 4, 0, 2], dtype=int64))。返回值loc中的两个元素，分别表示匹配值的行索引和列索引。</li></ul> <h3 id="_2-循环"><a href="#_2-循环" class="header-anchor">#</a> <strong>2.循环</strong></h3> <p>要处理多个值，通常需要用到循环。例如，有一个列表，其中的值为71、23、16，希望将这些值逐个输出，可以这样写代码：</p> <div class="language-python extra-class"><pre class="language-python"><code>value <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">71</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> value<span class="token punctuation">:</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'value内的值：'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
</code></pre></div><p>运行上述代码，得到的输出结果为：</p> <div class="language-python extra-class"><pre class="language-python"><code>value内的值： <span class="token number">71</span>
value内的值： <span class="token number">23</span>
value内的值： <span class="token number">16</span>
</code></pre></div><p>因此，在获取匹配值的索引集合后，可以采用如下语句遍历所有匹配的位置，对这些位置做标记：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">for</span> i <span class="token keyword">in</span> 匹配位置集合：
标记匹配位置。
</code></pre></div><h3 id="_3-在循环中使用函数zip"><a href="#_3-在循环中使用函数zip" class="header-anchor">#</a> <strong>3.在循环中使用函数zip()</strong></h3> <p>函数zip()用可迭代的对象作为参数，将对象中对应的元素<strong>打包成一个个元组</strong>，然后返回由这些<strong>元组组成的列表</strong>。例如，以下代码使用函数zip()将t内对应的元素打包成一个个元组，并打印了由这些元组组成的列表：</p> <div class="language-python extra-class"><pre class="language-python"><code>x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>
y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span>
z <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span>
t <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>t<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
</code></pre></div><p>上述代码中，语句print(t)将t内的元素输出，结果为：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>循环语句for i in zip(*t)将t内的元素打包成元组后输出，结果为：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>
</code></pre></div><p>因此，如果希望循环遍历由np.where()返回的模板匹配索引集合，可以采用的语句为：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>模板匹配索引集合<span class="token punctuation">)</span><span class="token punctuation">:</span>
标记处理
</code></pre></div><p>例如，对于前面提到的数组am，使用函数zip()循环，就可以得到其中大于5的元素索引的集合：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
am<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">77</span><span class="token punctuation">,</span><span class="token number">66</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">98</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">67</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>am<span class="token punctuation">)</span>
b<span class="token operator">=</span>np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>am<span class="token operator">&gt;</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
</code></pre></div><p>上述代码的输出结果为：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">3</span>  <span class="token number">6</span>  <span class="token number">8</span> <span class="token number">77</span> <span class="token number">66</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span> <span class="token number">1</span>  <span class="token number">2</span> <span class="token number">88</span>  <span class="token number">3</span> <span class="token number">98</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">11</span>  <span class="token number">2</span> <span class="token number">67</span>  <span class="token number">5</span>  <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_4-调整坐标"><a href="#_4-调整坐标" class="header-anchor">#</a> <strong>4.调整坐标</strong></h3> <p>函数numpy.where()可以获取满足条件的模板匹配位置集合，然后可以使用函数cv2.rectangle()在上述匹配位置绘制矩形来标注匹配位置。使用函数numpy.where()在函数cv2.matchTemplate()的输出值中查找指定值，得到的形式为“（行号，列号）”的位置索引。但是，函数cv2.rectangle()中用于指定顶点的参数所使用的是形式为“（列号，行号）”的位置索引。所以，在使用函数cv2.rectangle()绘制矩形前，要先将函数numpy.where()得到的位置索引做“<strong>行列互换</strong>”。可以使用如下语句实现loc内行列位置的互换：</p> <div class="language-python extra-class"><pre class="language-python"><code>loc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
</code></pre></div><p>如下语句将loc内的两个元素交换位置：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
loc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>loc<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>loc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>其中，语句print(loc)所对应的输出为：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>语句print(loc[::-1])所对应的输出为：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_5-标记匹配图像的位置"><a href="#_5-标记匹配图像的位置" class="header-anchor">#</a> <strong>5.标记匹配图像的位置</strong></h3> <p>函数cv2.rectangle()可以标记匹配图像的具体位置，分别指定要标记的原始图像、对角顶点、颜色、矩形边线宽度即可。关于矩形的对角顶点：</p> <ul><li>其中的一个对角顶点A可以通过for循环语句从确定的满足条件的“匹配位置集合”内获取。</li> <li>另外一个对角顶点，可以通过顶点A的位置与模板的宽（w）和高（h）进行运算得到。</li></ul> <p>因此，标记各个匹配位置的语句为：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">for</span> i <span class="token keyword">in</span> 匹配位置集合：
   cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>输入图像，i<span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w<span class="token punctuation">,</span> i<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>例三</strong>：使用模板匹配方式，标记在输入图像内与模板图像匹配的多个子图像。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
<span class="token comment"># 原始图像</span>
img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'lena4.bmp'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment"># 模板图像</span>
template <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'lena4Temp.bmp'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment"># 横纵坐标翻转</span>
w<span class="token punctuation">,</span> h <span class="token operator">=</span> template<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment"># 匹配</span>
res <span class="token operator">=</span> cv2<span class="token punctuation">.</span>matchTemplate<span class="token punctuation">(</span>img<span class="token punctuation">,</span> template<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>TM_CCOEFF_NORMED<span class="token punctuation">)</span>
<span class="token comment"># 设置匹配阈值</span>
threshold <span class="token operator">=</span> <span class="token number">0.9</span>
<span class="token comment"># 查找匹配大于阈值的图像集合</span>
loc <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span> res <span class="token operator">&gt;=</span> threshold<span class="token punctuation">)</span>
<span class="token comment"># 遍历集合</span>
<span class="token keyword">for</span> pt <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>loc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> pt<span class="token punctuation">,</span> <span class="token punctuation">(</span>pt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w<span class="token punctuation">,</span> pt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cmap <span class="token operator">=</span> <span class="token string">'gray'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>yticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/assets/img/image-20221122205958-vinc1rl-16691225834909.457621b6.png" alt="image-20221122205958-vinc1rl"></p></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-ac050c62><li class="level-2" data-v-ac050c62><a href="/opencv/2022/1121001.html#思维导图" class="sidebar-link reco-side-思维导图" data-v-ac050c62>思维导图</a></li><li class="level-2" data-v-ac050c62><a href="/opencv/2022/1121001.html#模板匹配基础" class="sidebar-link reco-side-模板匹配基础" data-v-ac050c62>模板匹配基础</a></li><li class="level-2" data-v-ac050c62><a href="/opencv/2022/1121001.html#多模板匹配" class="sidebar-link reco-side-多模板匹配" data-v-ac050c62>多模板匹配</a></li><li class="level-3" data-v-ac050c62><a href="/opencv/2022/1121001.html#_1-获取匹配位置的集合" class="sidebar-link reco-side-_1-获取匹配位置的集合" data-v-ac050c62>1.获取匹配位置的集合</a></li><li class="level-3" data-v-ac050c62><a href="/opencv/2022/1121001.html#_2-循环" class="sidebar-link reco-side-_2-循环" data-v-ac050c62>2.循环</a></li><li class="level-3" data-v-ac050c62><a href="/opencv/2022/1121001.html#_3-在循环中使用函数zip" class="sidebar-link reco-side-_3-在循环中使用函数zip" data-v-ac050c62>3.在循环中使用函数zip()</a></li><li class="level-3" data-v-ac050c62><a href="/opencv/2022/1121001.html#_4-调整坐标" class="sidebar-link reco-side-_4-调整坐标" data-v-ac050c62>4.调整坐标</a></li><li class="level-3" data-v-ac050c62><a href="/opencv/2022/1121001.html#_5-标记匹配图像的位置" class="sidebar-link reco-side-_5-标记匹配图像的位置" data-v-ac050c62>5.标记匹配图像的位置</a></li></ul></main></div> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.012a0edf.js" defer></script><script src="/assets/js/5.a1716bf7.js" defer></script><script src="/assets/js/1.c02cc300.js" defer></script><script src="/assets/js/21.415aabec.js" defer></script>
  </body>
</html>
